<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å…¨èƒ½æ—…éŠåŠ©æ‰‹ V3.4 (åŒ¯ç‡åŸºæº–èª¿æ•´)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .app-container {
            max-width: 480px;
            margin: 0 auto;
            background-color: #ffffff;
            min-height: 100vh;
            position: relative;
            padding-bottom: 90px;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
        }
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #6366f1; width: 20px; height: 20px; -webkit-animation: spin 1s linear infinite; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* è®“æ–‡å­—åœ¨é»æ“Šæ™‚ä¸æœƒæœ‰è—è‰²èƒŒæ™¯ */
        .no-highlight { -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body>

<div id="app" class="app-container">
    
    <div v-if="showSettings" class="fixed inset-0 bg-black bg-opacity-60 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl">
            <h3 class="text-xl font-bold mb-4 text-gray-800">ğŸŒ æ—…ç¨‹è¨­å®š</h3>
            <div class="space-y-4">
                
                <div>
                    <label class="text-xs font-bold text-gray-500 mb-1 block">ç›®çš„åœ° (åŸå¸‚å)</label>
                    <div class="flex space-x-2">
                        <input v-model="settings.destination" placeholder="ä¾‹å¦‚: å¤§é˜ª, é¦–çˆ¾, å·´é»" class="flex-1 bg-gray-50 p-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-indigo-500 outline-none">
                        <button @click="autoDetect" :disabled="isLoading" class="bg-indigo-600 text-white px-4 rounded-lg font-bold disabled:opacity-50">
                            <i v-if="!isLoading" class="fas fa-magic"></i>
                            <div v-else class="loader"></div>
                        </button>
                    </div>
                    <p class="text-[10px] text-gray-400 mt-1">*é»æ“Šé­”è¡“æ£’è‡ªå‹•åµæ¸¬å¤©æ°£èˆ‡å¹£åˆ¥</p>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs font-bold text-gray-500 mb-1 block">ç•¶åœ°å¹£åˆ¥ (å¦‚ JPY)</label>
                        <input v-model="settings.currency" class="w-full bg-gray-50 p-3 rounded-lg border border-gray-200 text-center uppercase">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500 mb-1 block">åŒ¯ç‡ (1 {{ settings.currency }} = ? TWD)</label>
                        <input v-model="settings.rate" type="number" step="0.0001" class="w-full bg-gray-50 p-3 rounded-lg border border-gray-200 text-center">
                        <p class="text-[10px] text-red-500 mt-1 font-bold">*è«‹ä»¥æ‚¨å¯¦éš›å…Œæ›åˆ°çš„åŒ¯ç‡æ‰‹å‹•èª¿æ•´ï¼Œä»¥ç¢ºä¿åˆ†å¸³ç²¾æº–ï¼</p>
                    </div>
                </div>

                <div class="pt-4 border-t border-gray-100">
                    <label class="text-xs font-bold text-gray-500 mb-2 block flex justify-between items-center">
                        æ—…ä¼´åå–® (ç”¨é€—è™Ÿåˆ†éš”)
                        <button @click="addDefaultMember" class="text-indigo-500 text-xs font-medium">+ æ–°å¢</button>
                    </label>
                    
                    <div v-for="(member, index) in members" :key="index" class="flex space-x-2 mb-2">
                        <input v-model="members[index]" :placeholder="`æ—…ä¼´ ${index + 1}`" class="flex-1 bg-gray-50 p-3 rounded-lg border border-gray-200 outline-none">
                        <button v-if="members.length > 1" @click="removeMember(index)" class="bg-red-100 text-red-500 w-10 rounded-lg">
                            <i class="fas fa-trash-alt text-xs"></i>
                        </button>
                    </div>
                    <p class="text-[10px] text-gray-400 mt-1">*ç¬¬ä¸€å€‹æ—…ä¼´æœƒæ˜¯é è¨­çš„ä»˜æ¬¾äºº</p>
                </div>
                
                <button @click="saveSettings" class="w-full py-3 rounded-xl bg-indigo-600 text-white font-bold shadow-lg shadow-indigo-200 mt-2">
                    é–‹å§‹æ—…ç¨‹
                </button>
                <div class="text-center">
                   <button @click="resetAllData" class="text-xs text-red-400 underline mt-2">é‡ç½®æ‰€æœ‰è³‡æ–™</button>
                </div>
            </div>
        </div>
    </div>

    <header class="bg-indigo-600 text-white p-6 rounded-b-3xl shadow-lg sticky top-0 z-10 transition-all duration-300">
        <div class="flex justify-between items-start mb-4">
            <div>
                <div @click="showSettings = true" class="flex items-center space-x-2 cursor-pointer active:opacity-80">
                    <h1 class="text-2xl font-bold tracking-wide">{{ settings.destination || 'è¨­å®šç›®çš„åœ°' }}</h1>
                    <i class="fas fa-cog text-indigo-300 text-sm"></i>
                </div>
                <div v-if="weather.temp" class="flex items-center text-indigo-100 text-sm mt-1 space-x-3 bg-indigo-700 bg-opacity-30 px-3 py-1 rounded-full w-max">
                    <i :class="getWeatherIcon(weather.code)"></i>
                    <span>{{ weather.temp }}Â°C</span>
                    <span class="text-xs opacity-75">| {{ weather.desc }}</span>
                </div>
                <div v-else class="text-indigo-200 text-xs mt-1">è¨­å®šå¾Œé¡¯ç¤ºå¤©æ°£</div>
            </div>
            <div class="text-right">
                <div class="bg-white text-indigo-600 px-3 py-1 rounded-lg text-xs font-bold shadow-sm">
                    1 {{ settings.currency }} â‰ˆ {{ parseFloat(settings.rate).toFixed(3) }} TWD
                </div>
            </div>
        </div>
        
        <div v-if="currentTab === 'schedule'" class="flex space-x-3 overflow-x-auto no-scrollbar pb-1">
            <button v-for="day in days" :key="day.id" 
                @click="currentDay = day.id"
                :class="currentDay === day.id ? 'bg-white text-indigo-600 font-bold shadow-md' : 'bg-indigo-500 text-indigo-100'"
                class="px-4 py-1.5 rounded-full text-sm whitespace-nowrap transition-all">
                {{ day.name }}
            </button>
        </div>
    </header>

    <main class="p-5 min-h-[60vh]">
        
        <div v-if="currentTab === 'preparation'" class="space-y-4">
            <h2 class="text-xl font-bold text-gray-800">âœ… è¡Œå‰æº–å‚™èˆ‡å‚™å¿˜</h2>
            <p class="text-sm text-gray-500">è­·ç…§ã€ç°½è­‰ã€è¨‚æˆ¿ç¢ºèªã€æ·»è³¼ç‰©å“...ç­‰ï¼Œé»æ“Šå¯ç·¨è¼¯ã€‚</p>

            <div class="bg-white rounded-xl shadow-md divide-y divide-gray-100 border border-gray-100">
                <div v-for="(item, index) in preparationList" :key="index" class="p-4 flex items-center justify-between group">
                    <div class="flex items-center flex-1 no-highlight">
                        <input type="checkbox" :id="'prep-'+index" v-model="item.completed" @change="saveToLocal" class="form-checkbox h-5 w-5 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500">
                        <label :for="'prep-'+index" :class="item.completed ? 'line-through text-gray-400' : 'text-gray-800'" class="ml-3 font-medium flex-1 cursor-pointer">
                            <input v-model="item.text" @change="saveToLocal" class="w-full border-none focus:ring-0 p-0 text-sm font-medium focus:bg-gray-50 rounded-md">
                        </label>
                    </div>
                    <button @click="deleteItem('preparation', index)" class="text-gray-300 hover:text-red-500 p-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            </div>

            <div class="mt-4 flex space-x-2">
                <input v-model="newItemText.preparation" placeholder="æ–°å¢æº–å‚™é …ç›®" class="flex-1 bg-gray-100 p-3 rounded-xl border-none focus:ring-2 focus:ring-indigo-500 outline-none">
                <button @click="addItem('preparation')" class="bg-indigo-600 text-white w-12 h-12 rounded-xl text-lg"><i class="fas fa-plus"></i></button>
            </div>
        </div>

        <div v-if="currentTab === 'packing'" class="space-y-4">
            <h2 class="text-xl font-bold text-gray-800">ğŸ§³ è¡Œææ‰“åŒ…æ¸…å–®</h2>
            <p class="text-sm text-gray-500">æ‰“åŒ…æ™‚çš„æ ¸å°æ¸…å–®ï¼Œé»æ“Šåœ“åœˆå³å¯å‹¾é¸/å–æ¶ˆã€‚</p>
            
            <div class="bg-white rounded-xl shadow-md divide-y divide-gray-100 border border-gray-100">
                <div v-for="(item, index) in packingList" :key="index" class="p-4 flex items-center justify-between group">
                    <div class="flex items-center flex-1 no-highlight">
                        <input type="checkbox" :id="'pack-'+index" v-model="item.completed" @change="saveToLocal" class="form-checkbox h-5 w-5 text-green-600 rounded border-gray-300 focus:ring-green-500">
                        <label :for="'pack-'+index" :class="item.completed ? 'line-through text-gray-400' : 'text-gray-800'" class="ml-3 font-medium flex-1 cursor-pointer">
                            <input v-model="item.text" @change="saveToLocal" class="w-full border-none focus:ring-0 p-0 text-sm font-medium focus:bg-gray-50 rounded-md">
                        </label>
                    </div>
                    <button @click="deleteItem('packing', index)" class="text-gray-300 hover:text-red-500 p-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            </div>

            <div class="mt-4 flex space-x-2">
                <input v-model="newItemText.packing" placeholder="æ–°å¢è¡Œæé …ç›®" class="flex-1 bg-gray-100 p-3 rounded-xl border-none focus:ring-2 focus:ring-indigo-500 outline-none">
                <button @click="addItem('packing')" class="bg-green-600 text-white w-12 h-12 rounded-xl text-lg"><i class="fas fa-plus"></i></button>
            </div>
        </div>


        <div v-if="currentTab === 'schedule'" class="space-y-4">
            <div class="flex justify-between items-center">
                <h2 class="text-lg font-bold text-gray-800">ç•¶æ—¥è¡Œç¨‹</h2>
                <button @click="showAddEventModal = true" class="text-indigo-600 text-sm font-bold bg-indigo-50 px-3 py-1 rounded-full">+ æ–°å¢</button>
            </div>

            <div v-if="!schedule[currentDay] || schedule[currentDay].length === 0" class="text-center py-10 text-gray-400">
                <i class="fas fa-suitcase-rolling text-4xl mb-3 opacity-30"></i>
                <p>é»æ“Šå³ä¸Šæ–¹æ–°å¢è¡Œç¨‹</p>
            </div>

            <div v-else class="space-y-4">
                <div v-for="(item, index) in schedule[currentDay]" :key="index" class="relative pl-4 border-l-2 border-indigo-100 pb-2 group">
                    <div class="absolute -left-[9px] top-0 w-4 h-4 bg-indigo-500 rounded-full border-4 border-white shadow-sm"></div>
                    <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex justify-between items-start">
                        <div class="flex-1">
                            <span class="text-xs font-bold text-indigo-500 bg-indigo-50 px-2 py-0.5 rounded mb-1 inline-block">{{ item.time }}</span>
                            <h3 class="font-bold text-gray-800">{{ item.title }}</h3>
                            <p class="text-gray-500 text-sm mt-1 cursor-pointer hover:text-indigo-600" @click="openMap(item.location)">
                                <i class="fas fa-map-marker-alt mr-1 text-xs"></i>{{ item.location }}
                            </p>
                        </div>
                        <button @click="deleteEvent(index)" class="text-gray-300 hover:text-red-400 p-2">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="currentTab === 'wallet'" class="space-y-6">
            
            <div class="bg-gradient-to-r from-gray-900 to-gray-800 text-white rounded-2xl p-6 shadow-xl relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-10 text-6xl"><i class="fas fa-coins"></i></div>
                <p class="text-gray-400 text-xs uppercase tracking-wider mb-1">ç¸½æ”¯å‡º (æ›ç®—ç´„ TWD)</p>
                <h2 class="text-3xl font-bold">NT$ {{ Math.round(totalExpenseTwd).toLocaleString() }}</h2>
                <p class="text-xs text-gray-400 mt-1">åŸå¹£åˆ¥: {{ totalExpenseOriginal.toLocaleString() }} {{ settings.currency }}</p>
                
                <div class="mt-4 pt-4 border-t border-gray-700 grid grid-cols-2 gap-4">
                    <div v-for="member in members" :key="member">
                        <p class="text-xs text-gray-400">{{ member }} (TWD)</p>
                        <p :class="getBalance(member) >= 0 ? 'text-green-400' : 'text-red-400'" class="font-bold">
                            {{ getBalance(member) >= 0 ? '+' : '' }}{{ Math.round(getBalance(member)).toLocaleString() }}
                        </p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-gray-800">è¨˜ä¸€ç­†</h3>
                    <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">å¹£åˆ¥: {{ settings.currency }}</span>
                </div>
                <div class="space-y-3">
                    <input v-model="newExpense.amount" type="number" :placeholder="`é‡‘é¡ (${settings.currency})`" class="w-full bg-gray-50 p-3 rounded-lg border-none focus:ring-2 focus:ring-indigo-500 outline-none">
                    <input v-model="newExpense.note" type="text" placeholder="é …ç›® (ä¾‹å¦‚: äº¤é€šå¡)" class="w-full bg-gray-50 p-3 rounded-lg border-none focus:ring-2 focus:ring-indigo-500 outline-none">
                    
                    <div>
                        <p class="text-xs font-bold text-gray-500 mb-1">èª°ä»˜çš„éŒ¢ï¼Ÿ</p>
                        <div class="flex space-x-2 overflow-x-auto no-scrollbar pb-1">
                            <button v-for="m in members" @click="newExpense.payer = m"
                                :class="newExpense.payer === m ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-500'"
                                class="flex-1 py-2 px-3 rounded-lg text-sm font-medium transition-colors whitespace-nowrap">
                                {{ m }}
                            </button>
                        </div>
                    </div>

                    <div class="pt-2 border-t border-gray-100">
                        <p class="text-xs font-bold text-gray-500 mb-2">èª°è¦åˆ†é€™ç­†éŒ¢ï¼Ÿ (å·²é¸ {{ newExpense.split_among.length }} äºº)</p>
                        <div class="flex flex-wrap gap-2">
                            <button v-for="m in members" @click="toggleSplitMember(m)"
                                :class="newExpense.split_among.includes(m) ? 'bg-green-600 text-white' : 'bg-gray-100 text-gray-500'"
                                class="py-2 px-3 rounded-lg text-sm font-medium transition-colors">
                                {{ m }}
                            </button>
                        </div>
                        
                        <p v-if="newExpense.split_among.length > 0 && newExpense.amount > 0" class="text-xs text-green-600 mt-2">
                            æ¯äººæ‡‰æ”¤ï¼š{{ parseFloat(newExpense.amount / newExpense.split_among.length).toFixed(2) }} {{ settings.currency }}
                        </p>
                    </div>

                    <button @click="addExpense" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-md mt-4">æ–°å¢ç´€éŒ„</button>
                </div>
            </div>

            <div class="pb-10">
                <h3 class="font-bold text-gray-800 mb-3">æœ€è¿‘æ¶ˆè²»</h3>
                <div v-for="(log, idx) in expenses" :key="idx" class="flex justify-between items-start py-3 border-b border-gray-100">
                    <div class="flex items-center">
                        <div class="w-8 h-8 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-600 font-bold text-xs mr-3">{{ log.payer[0] }}</div>
                        <div>
                            <p class="font-bold text-gray-800 text-sm">{{ log.note }}</p>
                            <p class="text-xs text-gray-400">{{ log.payer }} å…ˆä»˜ (åˆ†çµ¦: {{ log.split_among.join(', ') }})</p>
                            <p class="text-xs text-gray-400 mt-1">
                                æ¯äººåˆ†æ”¤ï¼š<span class="font-bold text-indigo-600">{{ getIndividualShare(log) }}</span> {{ settings.currency }}
                            </p>
                        </div>
                    </div>
                    <div class="text-right">
                        <span class="font-bold text-gray-800 block">{{ log.amount.toLocaleString() }} <span class="text-xs font-normal">{{ settings.currency }}</span></span>
                        <span class="text-[10px] text-gray-400">â‰ˆ NT${{ Math.round(log.amount * settings.rate).toLocaleString() }}</span>
                    </div>
                    <button @click="deleteExpense(idx)" class="ml-3 text-gray-300 hover:text-red-400"><i class="fas fa-trash-alt"></i></button>
                </div>
            </div>
        </div>
    </main>

    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 px-2 py-3 flex justify-around items-center z-50 max-w-[480px] mx-auto pb-6">
        
        <button @click="currentTab = 'preparation'" :class="currentTab === 'preparation' ? 'text-indigo-600' : 'text-gray-400'" class="flex flex-col items-center space-y-1 w-1/4 transition-colors">
            <i class="fas fa-clipboard-check text-xl"></i>
            <span class="text-[10px] font-medium">è¡Œå‰</span>
        </button>
        
        <button @click="currentTab = 'schedule'" :class="currentTab === 'schedule' ? 'text-indigo-600' : 'text-gray-400'" class="flex flex-col items-center space-y-1 w-1/4 transition-colors">
            <i class="fas fa-calendar-alt text-xl"></i>
            <span class="text-[10px] font-medium">è¡Œç¨‹</span>
        </button>

        <button @click="currentTab = 'packing'" :class="currentTab === 'packing' ? 'text-indigo-600' : 'text-gray-400'" class="flex flex-col items-center space-y-1 w-1/4 transition-colors">
            <i class="fas fa-suitcase text-xl"></i>
            <span class="text-[10px] font-medium">è¡Œæ</span>
        </button>

        <button @click="currentTab = 'wallet'" :class="currentTab === 'wallet' ? 'text-indigo-600' : 'text-gray-400'" class="flex flex-col items-center space-y-1 w-1/4 transition-colors">
            <i class="fas fa-wallet text-xl"></i>
            <span class="text-[10px] font-medium">åˆ†å¸³</span>
        </button>
    </nav>

    <div v-if="showAddEventModal" class="fixed inset-0 bg-black bg-opacity-50 z-[70] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 max-h-[80vh] overflow-y-auto">
            <h3 class="text-lg font-bold mb-4">æ–°å¢è¡Œç¨‹</h3>

            <div class="mb-5 border-b border-gray-100 pb-4">
                <p class="text-xs font-bold text-gray-500 mb-2">âš¡ï¸ å¿«é€Ÿæ–°å¢æ¨¡æ¿</p>
                <div class="flex flex-wrap gap-2">
                    <button v-for="tpl in eventTemplates" :key="tpl.title" 
                        @click="useTemplate(tpl)"
                        class="bg-indigo-50 text-indigo-700 text-xs px-3 py-1.5 rounded-full font-medium hover:bg-indigo-100 transition-colors">
                        <i :class="tpl.icon" class="mr-1"></i> {{ tpl.title }}
                    </button>
                </div>
            </div>

            <div class="space-y-3">
                <p class="text-xs font-bold text-gray-500 mb-1">æ‰‹å‹•è¼¸å…¥</p>
                <input v-model="newEvent.time" type="time" class="w-full bg-gray-50 p-2 rounded">
                <input v-model="newEvent.title" placeholder="æ¨™é¡Œ (ä¾‹: æ™šé¤)" class="w-full bg-gray-50 p-2 rounded">
                <input v-model="newEvent.location" placeholder="åœ°é» (ä¾‹: æŸæŸé¤å»³)" class="w-full bg-gray-50 p-2 rounded">
            </div>
            <div class="mt-4 flex space-x-2">
                <button @click="showAddEventModal = false" class="flex-1 py-2 bg-gray-100 rounded text-gray-600">å–æ¶ˆ</button>
                <button @click="addEvent" class="flex-1 py-2 bg-indigo-600 text-white rounded">ç¢ºèª</button>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, watch, onMounted } = Vue;

    createApp({
        setup() {
            // --- State ---
            const currentTab = ref('schedule');
            const currentDay = ref('day1');
            const showSettings = ref(false);
            const showAddEventModal = ref(false);
            const isLoading = ref(false);

            const members = ref(['æˆ‘']); 
            
            // è³‡æ–™çµæ§‹
            const settings = ref({});
            const weather = ref({ temp: null, code: null, desc: '' });
            
            const days = ref([
                { id: 'day1', name: 'Day 1' },
                { id: 'day2', name: 'Day 2' },
                { id: 'day3', name: 'Day 3' },
                { id: 'day4', name: 'Day 4' },
                { id: 'day5', name: 'Day 5' }
            ]);

            const eventTemplates = ref([
                { title: 'é£¯åº— Check-in', icon: 'fas fa-hotel', defaultTitle: 'é£¯åº— Check-in', defaultLocation: 'å¡«å¯«é£¯åº—åç¨±/åœ°å€' },
                { title: 'æ©Ÿå ´äº¤é€š', icon: 'fas fa-plane-departure', defaultTitle: 'æ©Ÿå ´/è»Šç«™äº¤é€š', defaultLocation: 'å¡«å¯«äº¤é€šæ–¹å¼/ç«™å' },
                { title: 'æ™¯é»åƒè§€', icon: 'fas fa-camera', defaultTitle: 'æ™¯é»åƒè§€', defaultLocation: 'å¡«å¯«æ™¯é»åç¨±' },
                { title: 'åˆé¤', icon: 'fas fa-utensils', defaultTitle: 'åˆé¤', defaultLocation: 'å¡«å¯«åˆé¤é¤å»³' },
                { title: 'æ™šé¤', icon: 'fas fa-pizza-slice', defaultTitle: 'æ™šé¤', defaultLocation: 'å¡«å¯«æ™šé¤é¤å»³' },
                { title: 'è³¼ç‰©', icon: 'fas fa-shopping-bag', defaultTitle: 'è³¼ç‰©è¡Œç¨‹', defaultLocation: 'å¡«å¯«å•†å ´åç¨±' },
                { title: 'è‡ªç”±æ´»å‹•', icon: 'fas fa-walking', defaultTitle: 'è‡ªç”±æ´»å‹•', defaultLocation: 'ç„¡ç‰¹å®šåœ°é»' },
            ]);


            const preparationList = ref([
                { text: 'è­·ç…§æ•ˆæœŸæª¢æŸ¥', completed: false },
                { text: 'è³¼è²·æ—…éŠä¿éšª', completed: false },
                { text: 'å…Œæ›å¤–å¹£', completed: false },
                { text: 'ç¢ºèªé£¯åº— Check-in æ™‚é–“', completed: false }
            ]);
            const packingList = ref([
                { text: 'æ‰‹æ©Ÿå……é›»ç·š/è¡Œå‹•é›»æº', completed: false },
                { text: 'å€‹äººè—¥å“', completed: false },
                { text: 'æ›æ´—è¡£ç‰© (Tæ¤ x 5)', completed: false },
                { text: 'è½‰æ¥é ­/è®Šå£“å™¨', completed: false }
            ]);
            
            const schedule = ref({ day1: [], day2: [], day3: [], day4: [], day5: [] });
            const expenses = ref([]);
            
            // è¼¸å…¥æš«å­˜
            const newEvent = ref({ time: '', title: '', location: '' });
            const newExpense = ref({ 
                payer: 'æˆ‘', 
                amount: '', 
                note: '',
                split_among: ['æˆ‘'] 
            });

            const newItemText = ref({ preparation: '', packing: '' });


            // --- API Logic (Magic) ---
            
            const countryCurrencyMap = { 'JP': 'JPY', 'KR': 'KRW', 'US': 'USD', 'CN': 'CNY', 'HK': 'HKD', 'GB': 'GBP', 'FR': 'EUR', 'DE': 'EUR', 'IT': 'EUR', 'TH': 'THB', 'VN': 'VND' };
            // V3.4 é è¨­åŒ¯ç‡è®Šæ›´ç‚º JPY å…Œæ› TWD çš„æ¯”å€¼ (0.23 ä»£è¡¨ 1 JPY = 0.23 TWD)
            const defaultSettings = { destination: 'æ±äº¬', currency: 'JPY', rate: 0.23, lat: 35.6895, lon: 139.6917 }; 

            const autoDetect = async () => {
                if (!settings.value.destination) return;
                isLoading.value = true;
                
                try {
                    // 1. Geocoding
                    const geoRes = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${settings.value.destination}&count=1&language=zh&format=json`);
                    const geoData = await geoRes.json();
                    
                    if (geoData.results && geoData.results.length > 0) {
                        const loc = geoData.results[0];
                        settings.value.lat = loc.latitude;
                        settings.value.lon = loc.longitude;
                        
                        if (countryCurrencyMap[loc.country_code]) {
                            settings.value.currency = countryCurrencyMap[loc.country_code];
                        }

                        // 2. Weather
                        fetchWeather();

                        // 3. Exchange Rate Fetch (TWD base)
                        const rateRes = await fetch(`https://open.er-api.com/v6/latest/TWD`);
                        const rateData = await rateRes.json();
                        
                        if (rateData.rates && rateData.rates[settings.value.currency]) {
                            const twdToBaseRate = rateData.rates[settings.value.currency];
                            
                            // V3.4 é—œéµä¿®æ”¹ï¼šå°‡ TWD/Local æ›ç®—æˆ Local/TWD (å–å€’æ•¸)
                            if (twdToBaseRate !== 0) {
                                settings.value.rate = 1 / twdToBaseRate; 
                                alert(`åŒ¯ç‡åµæ¸¬å®Œæˆï¼1 ${settings.value.currency} â‰ˆ ${settings.value.rate.toFixed(4)} TWD`);
                            } else {
                                alert('ç„¡æ³•è‡ªå‹•åµæ¸¬åŒ¯ç‡ï¼Œè«‹æª¢æŸ¥ç›®çš„åœ°å¹£åˆ¥æˆ–æ‰‹å‹•è¼¸å…¥ã€‚');
                            }
                        } else {
                            alert('ç„¡æ³•è‡ªå‹•åµæ¸¬åŒ¯ç‡ï¼Œè«‹æª¢æŸ¥ç›®çš„åœ°å¹£åˆ¥æˆ–æ‰‹å‹•è¼¸å…¥ã€‚');
                        }
                    } else {
                        alert('æ‰¾ä¸åˆ°è©²åœ°é»ï¼Œè«‹å˜—è©¦è¼¸å…¥è‹±æ–‡åç¨±');
                    }
                } catch (e) {
                    console.error(e);
                    alert('åµæ¸¬å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯');
                } finally {
                    isLoading.value = false;
                }
            };

            const fetchWeather = async () => {
                try {
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${settings.value.lat}&longitude=${settings.value.lon}&current_weather=true`);
                    const data = await res.json();
                    weather.value.temp = data.current_weather.temperature;
                    weather.value.code = data.current_weather.weathercode;
                    weather.value.desc = getWeatherDesc(data.current_weather.weathercode);
                } catch (e) { console.error("Weather error", e); }
            };

            const getWeatherIcon = (code) => {
                if (code <= 1) return 'fas fa-sun text-yellow-300';
                if (code <= 3) return 'fas fa-cloud-sun text-gray-300';
                if (code <= 48) return 'fas fa-smog text-gray-400';
                if (code <= 67) return 'fas fa-cloud-rain text-blue-300';
                if (code <= 77) return 'fas fa-snowflake text-white';
                return 'fas fa-cloud text-gray-300';
            };
            
            const getWeatherDesc = (code) => {
                if (code <= 1) return 'æ™´æœ—';
                if (code <= 3) return 'å¤šé›²';
                if (code <= 67) return 'æœ‰é›¨';
                return 'é™°å¤©';
            };

            // --- Persistence (å­˜æª”) ---
            const saveToLocal = () => {
                const data = {
                    settings: settings.value,
                    schedule: schedule.value,
                    expenses: expenses.value,
                    members: members.value,
                    preparationList: preparationList.value,
                    packingList: packingList.value,
                };
                localStorage.setItem('myTripData_v2', JSON.stringify(data));
            };

            const loadFromLocal = () => {
                settings.value = defaultSettings; 

                const raw = localStorage.getItem('myTripData_v2');
                if (raw) {
                    const data = JSON.parse(raw);
                    Object.assign(settings.value, data.settings || {});
                    schedule.value = data.schedule || schedule.value;
                    expenses.value = data.expenses || expenses.value;
                    members.value = data.members && data.members.length > 0 ? data.members : ['æˆ‘']; 
                    preparationList.value = data.preparationList || preparationList.value;
                    packingList.value = data.packingList || packingList.value;
                    
                    if(settings.value.lat) fetchWeather();
                } else {
                    showSettings.value = true;
                }
            };

            watch([schedule, expenses, settings, preparationList, packingList, members], saveToLocal, { deep: true });

            // --- Functional Logic ---
            
            // æ—…ä¼´ç®¡ç†
            const addDefaultMember = () => {
                members.value.push(`æ—…ä¼´ ${members.value.length + 1}`);
            };

            const removeMember = (index) => {
                const memberName = members.value[index];
                if(confirm(`ç¢ºå®šåˆªé™¤æ—…ä¼´ "${memberName}" å—ï¼Ÿæ‰€æœ‰èˆ‡ä»–ç›¸é—œçš„åˆ†å¸³ç´€éŒ„å°‡å¯èƒ½å°è‡´é¤˜é¡è¨ˆç®—ä¸æº–ç¢ºï¼`)) {
                    members.value.splice(index, 1);
                    if (newExpense.value.payer === memberName) {
                        newExpense.value.payer = members.value[0] || '';
                    }
                    newExpense.value.split_among = newExpense.value.split_among.filter(m => m !== memberName);
                }
            };

            // åˆ†å¸³ç®¡ç†
            const toggleSplitMember = (member) => {
                const index = newExpense.value.split_among.indexOf(member);
                if (index > -1) {
                    newExpense.value.split_among.splice(index, 1);
                } else {
                    newExpense.value.split_among.push(member);
                }
            };

            const getIndividualShare = (log) => {
                if (log.split_among.length === 0) return 0;
                return (log.amount / log.split_among.length).toFixed(2);
            }
            
            // ä½¿ç”¨æ¨¡æ¿åŠŸèƒ½
            const useTemplate = (tpl) => {
                newEvent.value.time = '';
                newEvent.value.title = tpl.defaultTitle;
                newEvent.value.location = tpl.defaultLocation;
            };

            // æ¸…å–®é€šç”¨æ“ä½œ (åŒ V3.3)
            const addItem = (listType) => {
                const list = listType === 'preparation' ? preparationList.value : packingList.value;
                const textRef = listType === 'preparation' ? newItemText.value.preparation : newItemText.value.packing;
                
                if (textRef.trim()) {
                    list.push({ text: textRef.trim(), completed: false });
                    if (listType === 'preparation') newItemText.value.preparation = '';
                    else newItemText.value.packing = '';
                }
            };

            const deleteItem = (listType, index) => {
                if(confirm('ç¢ºå®šåˆªé™¤æ­¤é …ç›®ï¼Ÿ')) {
                    const list = listType === 'preparation' ? preparationList.value : packingList.value;
                    list.splice(index, 1);
                }
            };
            
            // è¡Œç¨‹æ“ä½œ (åŒ V3.3)
            const addEvent = () => {
                if (!newEvent.value.title || !newEvent.value.time) {
                    alert('è«‹è‡³å°‘å¡«å¯«æ™‚é–“èˆ‡æ¨™é¡Œï¼');
                    return;
                }
                if (!schedule.value[currentDay.value]) schedule.value[currentDay.value] = [];
                schedule.value[currentDay.value].push({ ...newEvent.value });
                schedule.value[currentDay.value].sort((a, b) => a.time.localeCompare(b.time));
                newEvent.value = { time: '', title: '', location: '' };
                showAddEventModal.value = false;
            };

            const deleteEvent = (index) => {
                if(confirm('åˆªé™¤æ­¤è¡Œç¨‹ï¼Ÿ')) schedule.value[currentDay.value].splice(index, 1);
            };

            const openMap = (loc) => {
                window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc)}`, '_blank');
            };

            // åˆ†å¸³æ“ä½œ (åŒ V3.3)
            const addExpense = () => {
                if (!newExpense.value.amount || !newExpense.value.note) {
                    alert('è«‹å¡«å¯«é‡‘é¡èˆ‡é …ç›®ï¼');
                    return;
                }
                if (newExpense.value.split_among.length === 0) {
                    alert('è«‹é¸æ“‡è‡³å°‘ä¸€ä½åˆ†å¸³å°è±¡ï¼');
                    return;
                }

                expenses.value.unshift({ 
                    payer: newExpense.value.payer, 
                    amount: parseFloat(newExpense.value.amount),
                    note: newExpense.value.note,
                    split_among: [...newExpense.value.split_among]
                });
                
                newExpense.value.amount = '';
                newExpense.value.note = '';
                newExpense.value.payer = members.value[0] || '';
                newExpense.value.split_among = members.value.slice(); 
            };
            
            const deleteExpense = (index) => {
                if(confirm('åˆªé™¤æ­¤ç´€éŒ„ï¼Ÿ')) expenses.value.splice(index, 1);
            };

            // è¨­å®šæ“ä½œ (åŒ V3.3)
            const saveSettings = () => {
                newExpense.value.payer = members.value[0] || '';
                newExpense.value.split_among = members.value.slice();

                showSettings.value = false;
                saveToLocal();
            };

            const resetAllData = () => {
                if(confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è³‡æ–™å—ï¼Ÿç„¡æ³•å¾©åŸå–”ï¼')) {
                    localStorage.removeItem('myTripData_v2');
                    location.reload();
                }
            };

            // --- Computed ---
            const totalExpenseOriginal = computed(() => expenses.value.reduce((acc, cur) => cur.amount ? acc + cur.amount : acc, 0));
            
            // V3.4 é—œéµä¿®æ”¹ï¼šç¸½æ”¯å‡ºæ›ç®—é‚è¼¯ï¼šé‡‘é¡ * åŒ¯ç‡
            const totalExpenseTwd = computed(() => {
                if(!settings.value.rate || settings.value.rate === 0) return 0;
                return totalExpenseOriginal.value * settings.value.rate;
            });

            // V3.4 é—œéµä¿®æ”¹ï¼šé¤˜é¡è¨ˆç®—é‚è¼¯ï¼šé‡‘é¡ * åŒ¯ç‡
            const getBalance = (member) => {
                let paidTwd = 0;
                let owedTwd = 0;
                
                if (!settings.value.rate || settings.value.rate === 0) return 0;

                expenses.value.forEach(expense => {
                    // V3.4 æ›ç®—ï¼šé‡‘é¡ * åŒ¯ç‡
                    const amountTwd = expense.amount * settings.value.rate; 
                    const splitCount = expense.split_among.length;
                    
                    if (expense.payer === member) {
                        paidTwd += amountTwd;
                    }

                    if (expense.split_among.includes(member) && splitCount > 0) {
                        owedTwd += amountTwd / splitCount;
                    }
                });
                
                return paidTwd - owedTwd;
            };

            // Init
            onMounted(() => {
                loadFromLocal();
                newExpense.value.payer = members.value[0] || '';
                newExpense.value.split_among = members.value.slice();
            });

            return {
                currentTab, currentDay, days, showSettings, isLoading,
                settings, weather, members, schedule, expenses,
                preparationList, packingList, newItemText, eventTemplates,
                showAddEventModal, newEvent, newExpense,
                addDefaultMember, removeMember, toggleSplitMember,
                getIndividualShare,
                autoDetect, getWeatherIcon, saveSettings, resetAllData,
                addItem, deleteItem, useTemplate,
                addEvent, deleteEvent, addExpense, deleteExpense, openMap,
                totalExpenseTwd, totalExpenseOriginal, getBalance
            };
        }
    }).mount('#app');
</script>
</body>
</html>
